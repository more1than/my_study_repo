### TCP运输连接管理

#### 1.建立TCP连接（三次握手，三报文握手）

需要解决的问题：

1）双方都确知对方的存在

2）TCP双方能够协商参数（最大窗口值等）

3）TCP双方能够对运输实体资源进行分配

##### 连接流程：

主动连接成为TCP客户，被动链接成为TCP服务器

一开始TCP服务器进程首先创建TCP传输控制块，用来存储连接中的一些信息例如TCP连接表此时TCP 服务器进入监听状态，TCP客户进程首先创建TCP传输控制块，然后像TCP服务器发送连接请求报文段，并进入同步已发送状态，TCP连接请求报文段中的SYN被设置为1,表明这是一个TCP连接请求报文段，序号字段seq被设置了一个初始值x,作为TCP客户进程所选择的初始序号，服务器收到请求报文段后，向TCP客户发送TCP连接请求确认报文段，并进入同步已接受状态，该报文段首部中的同步位SYN和却认为ACK都设置为1，表明这是一个TCP连接请求确认报文段，序号字段seq被设置一个初始值y，作为TCP服务器的初始序号，ack的值被设置成x+1这是对seq的初始值的确认。TCP客户进程收到确认报文段后，还要向服务器发送一个普通的TCP确认报文段，并进入连接已建立状态，该报文段首部中的ACK被设置为1，表明这是一个普通的TCP确认报文段，序号字段seq被设置为x+1这是因为第一个序号为x，确认字段ack被设置为y+1，这是对服务器序号seq=y的确认，TCP服务器进程收到TCP确认报文段后，也进入连接已建立状态，完成连接建立。

#### 2.数据传送

#### 3.释放连接（四次挥手，四报文挥手）

##### 释放流程：

TCP客户主动关闭，服务器称之为被动关闭连接

TCP客户向TCP服务器发送TCP连接释放报文段并进入终止等待1状态，终止位FIN和ACK都为1，表明这是一个TCP连接释放报文段，并对之前收到的报文段进行确认，序号seq报文段设置为u，它等于客户之前传送过的序号加1，确认号ack值为v,等于TCP客户进程之前已收到的数据的最后一个字节序号加1，服务器收到报文段后发送确认报文段并进入关闭等待状态，该报文段首部ACK的值设置为1，表明这是一个普通的TCP确认报文段，序号seq字段的值设置为v，这是前一个收到的字节序号加1，确认号ack为u+1是TCP客户进程之前已收到的数据的最后一个字节序号加1，服务器进入半关闭状态，客户进程收到 确认报文段后进入终止等待2状态，等待服务器进程发出的TCP连接释放报文段，服务器进程发送TCP释放连接并进入最后确认状态，该报文段中的FIN和ACK都为1，证明是TCP连接释放报文段，同时对之前收到的值进行确认，确认号ack的值为u+1，这是对之前的报文进行确认，客户进程对TCP连接释放报文段进行确认，该报文段中的ACK值被设置为1，seq设置为u+1，延续之前的序号，ack为w+1这是对之前的报文进行确认，服务器进程收到该报文段后进入关闭状态，客户进程进行两倍的MSL（MSL最长报文寿命，RSC793文档中建议为两分钟）后进入关闭状态，至此连接成功释放。

**进入时间等待状态是为了考虑最后的确认报文丢失无法重传的问题**

保活计时器：如果建立连接后，客户进程崩掉，TCP服务器进程的策略是每收到一次TCP客户进程的数据，就重新设置并启动保活计时器（2小时定时），若定时周期内未收到数据，保活计时器到时后发送探测报文段，75秒发送一个，若10个探测报文段仍无TCP客户进程的响应，则关闭连接